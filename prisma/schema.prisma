// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

enum Industry {
  HVAC
  PLUMBING
  AUTO_REPAIR
  CHILDCARE
  ELECTRICIAN
  GENERIC
}

enum PlanType {
  STARTER
  PRO
  LOCAL_PLUS
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  clerkId    String?  @unique
  role       UserRole @default(CUSTOMER)
  businessId String?
  business   Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([businessId])
  @@index([clerkId])
}

model Business {
  id                String    @id @default(cuid())
  name              String
  industry          Industry
  phoneNumber       String?
  retellAgentId     String?   @unique
  stripeCustomerId  String?   @unique
  serviceAreas      String[]  @default([])
  businessHours     Json?     // { open: "09:00", close: "17:00", days: ["monday", "tuesday", ...] }
  address           String?
  city              String?
  state             String?
  zipCode           String?
  onboardingComplete Boolean  @default(false)
  requiresManualSetup Boolean @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  users       User[]
  calls       Call[]
  usage       Usage[]
  subscription Subscription?

  @@index([retellAgentId])
  @@index([stripeCustomerId])
}

model Call {
  id                String   @id @default(cuid())
  retellCallId      String   @unique
  businessId        String
  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  duration          Int      // Duration in seconds
  minutes           Float    // Duration in minutes (for billing)
  transcript        String?
  structuredIntake  Json?    // { name, phone, address, issue_description, emergency, etc. }
  emergencyFlag     Boolean  @default(false)
  callerName        String?
  callerPhone       String?
  issueDescription  String?
  createdAt         DateTime @default(now())

  @@index([businessId])
  @@index([retellCallId])
  @@index([createdAt])
  @@index([emergencyFlag])
}

model Usage {
  id            String   @id @default(cuid())
  businessId    String
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  minutesUsed   Float
  billingPeriod String   // Format: "YYYY-MM"
  reportedToStripe Boolean @default(false)
  stripeUsageRecordId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([businessId, billingPeriod])
  @@index([businessId])
  @@index([billingPeriod])
}

model Subscription {
  id                    String            @id @default(cuid())
  businessId            String            @unique
  business              Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  stripeSubscriptionId  String            @unique
  planType              PlanType
  status                SubscriptionStatus @default(ACTIVE)
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean           @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@index([stripeSubscriptionId])
  @@index([status])
}
