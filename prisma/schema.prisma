// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

enum Industry {
  HVAC
  PLUMBING
  AUTO_REPAIR
  CHILDCARE
  ELECTRICIAN
  HANDYMAN
  GENERIC
}

enum PlanType {
  STARTER
  PRO
  LOCAL_PLUS
}

enum LeadTag {
  EMERGENCY
  ESTIMATE
  FOLLOW_UP
  GENERAL
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
}

enum ClientStatus {
  PAUSED
  ACTIVE
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  supabaseUserId String?  @unique
  phoneNumber    String?  // For SMS notifications to owner
  role           UserRole @default(CUSTOMER)
  businessId     String?
  business       Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([businessId])
  @@index([supabaseUserId])
}

model Business {
  id                        String        @id @default(cuid())
  name                      String
  industry                  Industry
  primaryForwardingNumber   String        @unique // E.164; one business per number (trial eligibility)
  stripeCustomerId          String?       @unique
  serviceAreas              String[]      @default([])
  businessHours             Json?         // { open: "09:00", close: "17:00", days: ["monday", "tuesday", ...] }
  departments               String[]      @default([]) // Local Plus: e.g. ["Plumbing", "HVAC"]
  address                   String?
  city                      String?
  state                     String?
  zipCode                   String?
  onboardingComplete        Boolean       @default(false)
  requiresManualSetup       Boolean       @default(false)
  status                    ClientStatus  @default(PAUSED) // ACTIVE = answer calls and bill; PAUSED = do not connect
  testCallVerifiedAt        DateTime?     // Set when first completed call received for this client (forwarded_from matched)
  crmWebhookUrl             String?       // Pro+: POST lead data to CRM
  forwardToEmail            String?       // Pro+: forward leads to this email (e.g. CRM pipe)
  afterHoursEmergencyPhone  String?       // Pro only: on-call number for after-hours emergencies (not Local Plus)
  offersRoadsideService     Boolean?      // For AUTO_REPAIR: true = collect location for roadside
  voiceSettings             Json?         // Local Plus: { speed?, temperature?, volume? } 0â€“1 or similar
  // Trial (one per business; no separate TrialClaim table)
  trialStartedAt            DateTime?     // When trial started
  trialEndsAt               DateTime?     // trialStartedAt + 14 days
  trialMinutesUsed          Float        @default(0) // Minutes counting toward 50-minute trial cap
  // Subscription (merged from Subscription table; one plan per business)
  planType                  PlanType?
  stripeSubscriptionId      String?       @unique
  subscriptionStatus        SubscriptionStatus?
  currentPeriodStart        DateTime?
  currentPeriodEnd          DateTime?
  cancelAtPeriodEnd         Boolean       @default(false)
  createdAt                 DateTime     @default(now())
  updatedAt                 DateTime     @updatedAt

  users         User[]
  calls         Call[]
  usage         Usage[]

  @@index([primaryForwardingNumber])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([subscriptionStatus])
}

model Call {
  id                    String    @id @default(cuid())
  retellCallId          String    @unique
  businessId            String
  business              Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  callerNumber          String?   // E.164 caller (Retell from_number)
  forwardedFromNumber   String?   // E.164 number that forwarded (client line); routing key
  aiNumberAnswered      String?   // E.164 shared intake number (Retell to_number)
  duration              Int       // Duration in seconds
  minutes               Float     // Duration in minutes (for billing)
  transcript            String?
  summary               String?   // Short summary (Pro+)
  structuredIntake      Json?     // { name, phone, address, issue_description, emergency, appointmentRequest, etc. }
  emergencyFlag         Boolean   @default(false)
  leadTag               LeadTag?  // Pro+: EMERGENCY | ESTIMATE | FOLLOW_UP | GENERAL
  department            String?   // Local Plus: which department was requested
  appointmentRequest    Json?     // Pro+: { preferredDays?, preferredTime?, notes? }
  callerName            String?
  callerPhone           String?
  issueDescription      String?
  missedCallRecovery    Boolean   @default(false) // True if call ended early but we captured partial info
  createdAt             DateTime  @default(now())

  @@index([businessId])
  @@index([retellCallId])
  @@index([forwardedFromNumber])
  @@index([createdAt])
  @@index([emergencyFlag])
  @@index([leadTag])
}

model Usage {
  id               String   @id @default(cuid())
  businessId       String
  business         Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  minutesUsed      Float
  billingPeriod   String   // Format: "YYYY-MM"
  reportedToStripe Boolean  @default(false)
  stripeUsageRecordId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([businessId, billingPeriod])
  @@index([businessId])
  @@index([billingPeriod])
}
